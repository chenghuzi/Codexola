name: Build Universal DMG

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-dmg:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - uses: dtolnay/rust-toolchain@stable

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/codexola-signing.keychain-db"
          KEYCHAIN_PASSWORD="codexola"
          python3 - <<'PY'
          import base64, os, pathlib
          data = base64.b64decode(os.environ["APPLE_CERTIFICATE_P12_BASE64"])
          pathlib.Path("cert.p12").write_bytes(data)
          PY
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import cert.p12 -k "$KEYCHAIN_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | awk '/Developer ID Application/ {print $2; exit}')
          if [ -n "$IDENTITY" ]; then
            echo "APPLE_SIGNING_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"
          fi

      - name: Sync version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Using version: ${VERSION}"
          export VERSION
          python3 - <<'PY'
          import json
          import os
          import re

          version = os.environ["VERSION"]

          tauri_conf = "src-tauri/tauri.conf.json"
          with open(tauri_conf, "r", encoding="utf-8") as f:
            data = json.load(f)
          data["version"] = version
          with open(tauri_conf, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2)
            f.write("\n")

          package_json = "package.json"
          with open(package_json, "r", encoding="utf-8") as f:
            data = json.load(f)
          data["version"] = version
          with open(package_json, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2)
            f.write("\n")

          cargo_toml = "src-tauri/Cargo.toml"
          with open(cargo_toml, "r", encoding="utf-8") as f:
            text = f.read()
          updated = re.sub(r'(?m)^version\s*=\s*"[^"]+"', f'version = "{version}"', text, count=1)
          if text == updated:
            raise SystemExit("Failed to update Cargo.toml version")
          with open(cargo_toml, "w", encoding="utf-8") as f:
            f.write(updated)
          PY

      - run: npm ci
      - name: Build universal DMG
        run: npm run build:universal-dmg

      - name: Notarize and staple DMG
        env:
          APPLE_API_KEY_P8_BASE64: ${{ secrets.APPLE_API_KEY_P8_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import base64, os, pathlib
          data = base64.b64decode(os.environ["APPLE_API_KEY_P8_BASE64"])
          pathlib.Path("AuthKey.p8").write_bytes(data)
          PY
          DMG=$(ls src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg | head -n1)
          xcrun notarytool submit "$DMG" --key AuthKey.p8 --key-id "$APPLE_API_KEY_ID" --issuer "$APPLE_API_ISSUER_ID" --wait
          xcrun stapler staple "$DMG"
          spctl -a -vv -t install "$DMG"

      - uses: softprops/action-gh-release@v2
        with:
          files: src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
